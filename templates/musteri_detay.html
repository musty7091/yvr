{% extends "base.html" %}

{% block content %}
<div class="row g-4 mb-4">
    <div class="col-md-7">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item small"><a href="/musteriler" class="text-decoration-none">Müşteriler</a></li>
                <li class="breadcrumb-item small active">{{ musteri.ad_soyad }}</li>
            </ol>
        </nav>
        <h2 class="mb-1 fw-bold">{{ musteri.ad_soyad }}</h2>
        
        {% if musteri.isyeri_adi %}
        <p class="text-primary fw-medium mb-1"><i class="bi bi-building me-2"></i>{{ musteri.isyeri_adi }}</p>
        {% endif %}
        {% if musteri.isyeri_adresi %}
        <p class="text-muted small mb-0"><i class="bi bi-geo-alt me-2"></i>{{ musteri.isyeri_adresi }}</p>
        {% endif %}
        <p class="text-muted small mt-1"><i class="bi bi-telephone me-2"></i>{{ musteri.telefon or '-' }}</p>
    </div>
    
    <div class="col-md-5 text-md-end align-self-end mt-3 mt-md-0">
        <button class="btn btn-success btn-sm rounded-pill px-4 py-2 me-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#odemeEkleModal">
            <i class="bi bi-cash-coin me-2"></i>TAHSİLAT EKLE
        </button>
        <a href="/pdf_indir/{{ musteri.id }}" class="btn btn-outline-dark btn-sm rounded-pill px-4 py-2">
            <i class="bi bi-file-earmark-pdf me-2"></i>PDF İNDİR
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-12">
        <div class="card card-custom text-center border-0 shadow-sm" style="background: #fdfdfd; border-left: 5px solid #a2d2ff !important;">
            <div class="text-uppercase small fw-medium text-muted mb-1">GÜNCEL TOPLAM BAKİYE</div>
            <div class="h2 mb-0" style="color: #4a4a4a;">{{ "{:,.2f}".format(toplam_tl) }} ₺</div>
            <div class="small text-secondary">{{ "{:,.2f}".format(toplam_usd) }} USD</div>
        </div>
    </div>

    <div class="col-lg-7">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h5 class="mb-0 small fw-bold text-uppercase">Sipariş Geçmişi</h5>
        </div>
        <div class="card card-custom p-0 overflow-hidden border-0 shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="bg-light">
                        <th class="ps-4">Açıklama</th>
                        <th class="text-end pe-4">Tutar & İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    {% for is in musteri.isler %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-medium text-dark">{{ is.is_tanimi }}</div>
                            <div style="font-size: 0.75rem;" class="text-muted">{{ is.kayit_tarihi.strftime('%d.%m.%Y') }}</div>
                        </td>
                        <td class="text-end pe-4">
                            <span class="fw-medium me-3">{{ "{:,.2f}".format(is.toplam_bedel) }} {{ is.para_birimi }}</span>
                            <a href="/is_sil/{{ is.id }}" onclick="return confirm('Bu iş kaydını silmek istediğinize emin misiniz? Bakiyeden düşülecektir.');" class="text-danger small"><i class="bi bi-trash"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not musteri.isler %}
                    <tr><td colspan="2" class="text-center py-4 text-muted small">Henüz iş kaydı açılmamış.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="col-lg-5">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h5 class="mb-0 small fw-bold text-uppercase">Tahsilatlar</h5>
        </div>
        <div class="card card-custom p-0 overflow-hidden border-0 shadow-sm">
            <table class="table table-hover align-middle mb-0">
                <thead>
                    <tr class="bg-light">
                        <th class="ps-4">Not</th>
                        <th class="text-end pe-4">Tutar & İşlem</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in musteri.odemeler %}
                    <tr>
                        <td class="ps-4">
                            <div class="fw-medium text-dark small">{{ o.aciklama }}</div>
                            {% if o.birim != 'TL' %}<div style="font-size: 0.65rem;" class="text-muted">Kur: {{ o.kur_degeri }}</div>{% endif %}
                        </td>
                        <td class="text-end pe-4">
                            <span class="text-success small fw-medium me-3">+ {{ "{:,.2f}".format(o.tutar) }} {{ o.birim }}</span>
                            <a href="/odeme_sil/{{ o.id }}" onclick="return confirm('Bu tahsilat kaydını silmek istediğinize emin misiniz? Bakiye artacaktır.');" class="text-danger small"><i class="bi bi-trash"></i></a>
                        </td>
                    </tr>
                    {% endfor %}
                    {% if not musteri.odemeler %}
                    <tr><td colspan="2" class="text-center py-4 text-muted small">Henüz tahsilat yapılmamış.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="odemeEkleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow" style="border-radius: 20px;">
            <div class="modal-body p-4">
                <h6 class="fw-bold mb-4 text-center text-uppercase">Tahsilat Kaydı Al</h6>
                <form action="/musteri_odeme_ekle/{{ musteri.id }}" method="POST">
                    <div class="mb-3">
                        <label class="form-label small">TUTAR</label>
                        <input type="number" step="0.01" name="tutar" class="form-control bg-light border-0 p-3" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small">PARA BİRİMİ</label>
                        <select name="birim" class="form-select bg-light border-0">
                            <option value="TL">₺ (TL)</option>
                            <option value="USD">$ (USD)</option>
                            <option value="EUR">€ (EUR)</option>
                            <option value="GBP">£ (GBP)</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="form-label small">NOT / AÇIKLAMA</label>
                        <input type="text" name="aciklama" class="form-control bg-light border-0 p-3" placeholder="Örn: Nakit Tahsilat">
                    </div>
                    <button type="submit" class="btn btn-yvr-primary w-100 py-3">İŞLEMİ KAYDET</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}